<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" type="image/x-icon" href="https://cinearena.github.io/astro-jwplyr/faviconimg.jpeg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cine Arena</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/controls.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            background: #000;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        .shaka-video-container {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
        }
        
        video {
            width: 100%;
            height: 100%;
            background: #000;
            object-fit: contain;
        }

        /* YouTube Theme CSS */
        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/roboto/v27/KFOmCnqEu92Fr1Me5Q.ttf) format('truetype');
        }
        
        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 500;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/roboto/v27/KFOlCnqEu92Fr1MmEU9vAw.ttf) format('truetype');
        }
        
        .youtube-theme {
            font-family: 'Roboto', sans-serif;
        }
        
        .youtube-theme .shaka-bottom-controls {
            width: 100%;
            padding: 0;
            padding-bottom: 0;
            z-index: 1;
        }
        
        .youtube-theme .shaka-bottom-controls {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
                -ms-flex-direction: column;
                    flex-direction: column;
        }
        
        .youtube-theme .shaka-ad-controls {
            -webkit-box-ordinal-group: 2;
                -ms-flex-order: 1;
                    order: 1;
        }
        
        .youtube-theme .shaka-controls-button-panel {
            -webkit-box-ordinal-group: 3;
                -ms-flex-order: 2;
                    order: 2;
            height: 40px;
            padding: 0 10px;
        }
        
        .youtube-theme .shaka-range-container {
            margin: 4px 10px 4px 10px;
            top: 0;
        }
        
        .youtube-theme .shaka-small-play-button {
            -webkit-box-ordinal-group: -2;
                -ms-flex-order: -3;
                    order: -3;
        }
        
        .youtube-theme .shaka-mute-button {
            -webkit-box-ordinal-group: -1;
                -ms-flex-order: -2;
                    order: -2;
        }
        
        .youtube-theme .shaka-controls-button-panel > * {
            margin: 0;
            padding: 3px 8px;
            color: #EEE;
            height: 40px;
        }
        
        .youtube-theme .shaka-controls-button-panel > *:focus {
            outline: none;
            -webkit-box-shadow: inset 0 0 0 2px rgba(27, 127, 204, 0.8);
                    box-shadow: inset 0 0 0 2px rgba(27, 127, 204, 0.8);
            color: #FFF;
        }
        
        .youtube-theme .shaka-controls-button-panel > *:hover {
            color: #FFF;
        }
        
        .youtube-theme .shaka-controls-button-panel .shaka-volume-bar-container {
            position: relative;
            z-index: 10;
            left: -1px;
            -webkit-box-ordinal-group: 0;
                -ms-flex-order: -1;
                    order: -1;
            opacity: 0;
            width: 0px;
            -webkit-transition: width 0.2s cubic-bezier(0.4, 0, 1, 1);
            height: 3px;
            transition: width 0.2s cubic-bezier(0.4, 0, 1, 1);
            padding: 0;
        }
        
        .youtube-theme .shaka-controls-button-panel .shaka-volume-bar-container:hover,
        .youtube-theme .shaka-controls-button-panel .shaka-volume-bar-container:focus {
            display: block;
            width: 50px;
            opacity: 1;
            padding: 0 6px;
        }
        
        .youtube-theme .shaka-mute-button:hover + div {
            opacity: 1;
            width: 50px;
            padding: 0 6px;
        }
        
        .youtube-theme .shaka-current-time {
            padding: 0 10px;
            font-size: 12px;
        }
        
        .youtube-theme .shaka-seek-bar-container {
            height: 3px;
            position: relative;
            top: -1px;
            border-radius: 0;
            margin-bottom: 0;
        }
        
        .youtube-theme .shaka-seek-bar-container .shaka-range-element {
            opacity: 0;
        }
        
        .youtube-theme .shaka-seek-bar-container:hover {
            height: 5px;
            top: 0;
            cursor: pointer;
        }
        
        .youtube-theme .shaka-seek-bar-container:hover .shaka-range-element {
            opacity: 1;
            cursor: pointer;
        }
        
        .youtube-theme .shaka-seek-bar-container input[type=range]::-webkit-slider-thumb {
            background: #FF0000;
            cursor: pointer;
        }
        
        .youtube-theme .shaka-seek-bar-container input[type=range]::-moz-range-thumb {
            background: #FF0000;
            cursor: pointer;
        }
        
        .youtube-theme .shaka-seek-bar-container input[type=range]::-ms-thumb {
            background: #FF0000;
            cursor: pointer;
        }
        
        .youtube-theme .shaka-video-container * {
            font-family: 'Roboto', sans-serif;
        }
        
        .youtube-theme .shaka-video-container .material-icons-round {
            font-family: 'Material Icons Sharp';
        }
        
        .youtube-theme .shaka-overflow-menu,
        .youtube-theme .shaka-settings-menu {
            border-radius: 2px;
            background: rgba(28, 28, 28, 0.9);
            text-shadow: 0 0 2px rgb(0 0 0%);
            -webkit-transition: opacity 0.1s cubic-bezier(0, 0, 0.2, 1);
            transition: opacity 0.1s cubic-bezier(0, 0, 0.2, 1);
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-user-select: none;
            right: 10px;
            bottom: 50px;
            padding: 8px 0;
            min-width: 200px;
        }
        
        .youtube-theme .shaka-settings-menu {
            padding: 0 0 8px 0;
        }
        
        .youtube-theme .shaka-settings-menu button {
            font-size: 12px;
        }
        
        .youtube-theme .shaka-settings-menu button span {
            margin-left: 33px;
            font-size: 13px;
        }
        
        .youtube-theme .shaka-settings-menu button[aria-selected="true"] {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
        }
        
        .youtube-theme .shaka-settings-menu button[aria-selected="true"] span {
            -webkit-box-ordinal-group: 3;
                -ms-flex-order: 2;
                    order: 2;
            margin-left: 0;
        }
        
        .youtube-theme .shaka-settings-menu button[aria-selected="true"] i {
            -webkit-box-ordinal-group: 2;
                -ms-flex-order: 1;
                    order: 1;
            font-size: 18px;
            padding-left: 5px;
        }
        
        .youtube-theme .shaka-overflow-menu button {
            padding: 0;
        }
        
        .youtube-theme .shaka-overflow-menu button i {
            display: none;
        }
        
        .youtube-theme .shaka-overflow-menu button .shaka-overflow-button-label {
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
                -ms-flex-pack: justify;
                    justify-content: space-between;
            -webkit-box-orient: horizontal;
            -webkit-box-direction: normal;
                -ms-flex-direction: row;
                    flex-direction: row;
            -webkit-box-align: center;
                -ms-flex-align: center;
                    align-items: center;
            cursor: default;
            outline: none;
            height: 40px;
            -webkit-box-flex: 0;
                -ms-flex: 0 0 100%;
                    flex: 0 0 100%;
        }
        
        .youtube-theme .shaka-overflow-menu button .shaka-overflow-button-label span {
            -ms-flex-negative: initial;
                flex-shrink: initial;
            padding-left: 15px;
            font-size: 13px;
            font-weight: 500;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
                -ms-flex-align: center;
                    align-items: center;
        }
        
        .youtube-theme .shaka-overflow-menu span + span {
            color: #FFF;
            font-weight: 400 !important;
            font-size: 12px !important;
            padding-right: 8px;
            padding-left: 0 !important;
        }
        
        .youtube-theme .shaka-overflow-menu span + span:after {
            content: "navigate_next";
            font-family: 'Material Icons Sharp';
            font-size: 20px;
        }
        
        .youtube-theme .shaka-overflow-menu .shaka-pip-button span + span {
            padding-right: 15px !important;
        }
        
        .youtube-theme .shaka-overflow-menu .shaka-pip-button span + span:after {
            content: "";
        }
        
        .youtube-theme .shaka-back-to-overflow-button {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 12px;
            color: #eee;
            height: 40px;
        }
        
        .youtube-theme .shaka-back-to-overflow-button .material-icons-round {
            font-size: 15px;
            padding-right: 10px;
        }
        
        .youtube-theme .shaka-back-to-overflow-button span {
            margin-left: 3px !important;
        }
        
        .youtube-theme .shaka-overflow-menu button:hover,
        .youtube-theme .shaka-settings-menu button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        
        .youtube-theme .shaka-overflow-menu button:hover label,
        .youtube-theme .shaka-settings-menu button:hover label {
            cursor: pointer;
        }
        
        .youtube-theme .shaka-overflow-menu button:focus,
        .youtube-theme .shaka-settings-menu button:focus {
            background-color: rgba(255, 255, 255, 0.1);
            border: none;
            outline: none;
        }
        
        .youtube-theme .shaka-overflow-menu button,
        .youtube-theme .shaka-settings-menu button {
            color: #EEE;
        }
        
        .youtube-theme .shaka-captions-off {
            color: #BFBFBF;
        }
        
        .youtube-theme .shaka-overflow-menu-button {
            font-size: 18px;
            margin-right: 5px;
        }
        
        .youtube-theme .shaka-fullscreen-button:hover {
            font-size: 25px;
            -webkit-transition: font-size 0.1s cubic-bezier(0, 0, 0.2, 1);
            transition: font-size 0.1s cubic-bezier(0, 0, 0.2, 1);
        }

        /* Hide center loading spinner */
        .shaka-spinner-container,
        .shaka-spinner,
        .shaka-spinner-svg {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        /* Custom Seek Bar Colors */
        .youtube-theme .shaka-seek-bar {
            background: rgba(255,255,255,.2) !important;
        }
        
        .youtube-theme .shaka-buffered-range {
            background: rgba(255,255,255,.4) !important;
        }
        
        .youtube-theme .shaka-played-range {
            background: rgb(255,0,0) !important;
        }

        /* Manual play button styles - HIDDEN */
        .manual-play-button {
            display: none !important;
        }
        
        #myLogo {
            width: 65px;
            height: 25px;
            position: absolute;
            left: 5px;
            top: 5px;
            z-index: 99999 !important;
            pointer-events: auto !important;
            cursor: pointer;
        }

        /* allow click to pass */
        .shaka-video-container,
        video {
            pointer-events: auto !important;
        }

        /* Error message styling */
        .error-message {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 10000;
            max-width: 80%;
            border: 2px solid #ff0000;
        }

        /* Page loader - HIDDEN */
        .page-loader {
            display: none !important;
        }
        
        /* Iframe container */
        #iframeContainer {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 1000;
        }
        
        #iframeContainer iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }
        
        /* Auto fallback to iframe when Shaka fails */
        .shaka-video-container {
            z-index: 1;
        }
        
        /* Small mute indicator */
        .mute-indicator {
            position: absolute;
            top: 50px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            display: none;
            z-index: 9999;
        }
    </style>
</head>
<body>

<div class="shaka-video-container youtube-theme" data-shaka-player>
    <video playsinline preload="auto" poster="https://blogger.googleusercontent.com/img/a/AVvXsEiGqaZeRBZ6Y7yV5ZYSRiNRhBa5q9_EMx7R5TJcHd3XJwwHh2YhNOGt76Y4vEcUIjvIaA7W-Tw1RyMLP-4WZwVHA4mk18zwXl7HdSL5WabprIasDOWJO7jpL0zTQB4p_y7X0Rv0xwe-cJ-GvxofAgeRp2FIiNgB90n_b8Cqw0sAaZqVhJg_fi9UyfSO8KY"></video>
    <a href="https://t.me/cine_arena" target="_blank">
        <img id="myLogo" src="https://cricstream4u.github.io/cinearena/cineheader.png">
    </a>
    <!-- Manual play button is hidden by CSS -->
    <div class="manual-play-button" id="manualPlayButton"></div>
</div>

<div class="mute-indicator" id="muteIndicator">Click to unmute</div>

<div id="iframeContainer"></div>

<!-- Page loader is hidden by CSS -->
<div id="pageLoader" class="page-loader"></div>

<div id="errorMessage" class="error-message" style="display: none;">
    <p>An error occurred. Please try again.</p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.16.3/shaka-player.ui.min.js"></script>
<script>
    // Get URL parameters
    const queryParams = new URLSearchParams(window.location.search);
    const name = queryParams.get('url');
    const keyId = queryParams.get('keyId');
    const key = queryParams.get('key');
    
    // Global variables
    let player = null;
    let ui = null;
    let streamUrl = '';
    let cookieHeader = '';

    // Function to switch to iframe player
    function switchToIframe() {
        console.log('Switching to iframe player...');
        
        // Hide Shaka player
        document.querySelector('.shaka-video-container').style.display = 'none';
        
        // Show iframe container
        const iframeContainer = document.getElementById('iframeContainer');
        iframeContainer.style.display = 'block';
        
        // Clear existing iframe
        iframeContainer.innerHTML = '';
        
        // Create iframe
        const iframe = document.createElement('iframe');
        
        // Add autoplay parameters
        let iframeUrl = streamUrl;
        if (!iframeUrl.includes('autoplay=')) {
            iframeUrl += (iframeUrl.includes('?') ? '&' : '?') + 'autoplay=1&mute=0';
        }
        
        iframe.src = iframeUrl;
        iframe.setAttribute('allow', 'autoplay; encrypted-media; fullscreen; picture-in-picture');
        iframe.setAttribute('allowfullscreen', 'true');
        iframe.setAttribute('frameborder', '0');
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        
        iframeContainer.appendChild(iframe);
        
        console.log('Iframe player loaded');
    }

    // Function to initialize Shaka player
    async function initShakaPlayer() {
        try {
            // Check if Shaka is supported
            if (!shaka.Player.isBrowserSupported()) {
                console.log('Shaka not supported, switching to iframe');
                switchToIframe();
                return;
            }

            const video = document.querySelector('video');
            player = new shaka.Player();
            await player.attach(video);

            const container = document.querySelector('.shaka-video-container');
            ui = new shaka.ui.Overlay(player, container, video);

            // UI configuration
            const uiConfig = {
                controlPanelElements: [
                    'play_pause',
                    'time_and_duration',
                    'mute',
                    'volume',
                    'spacer',
                    'picture_in_picture',
                    'overflow_menu',
                    'fullscreen'
                ],
                addSeekBar: true,
                seekBarColors: {
                    base: 'rgba(255, 255, 255, 0.3)',
                    buffered: 'rgba(255, 255, 255, 0.5)',
                    played: 'rgba(220, 38, 38, 0.9)'
                },
                volumeBarColors: {
                    base: 'rgba(255,255,255,0.3)',
                    level: 'rgba(220,38,38,0.9)'
                },
                enableFullscreenOnRotation: true,
            };
            ui.configure(uiConfig);

            // DRM configuration if keys provided
            let drmConfig = {};
            if (keyId && key) {
                drmConfig = {
                    clearKeys: {
                        [keyId]: key
                    }
                };
            }

            // Configure player
            player.configure({
                drm: drmConfig,
                streaming: {
                    lowLatencyMode: true,
                    bufferingGoal: 15,
                    rebufferingGoal: 2,
                    bufferBehind: 15,
                    retryParameters: {
                        timeout: 10000,
                        maxAttempts: 5,
                        baseDelay: 300,
                        backoffFactor: 1.2
                    },
                    segmentRequestTimeout: 8000,
                    segmentPrefetchLimit: 2,
                    useNativeHlsOnSafari: true
                },
                manifest: {
                    retryParameters: {
                        timeout: 8000,
                        maxAttempts: 3
                    }
                }
            });

            // Setup request headers
            if (cookieHeader) {
                player.getNetworkingEngine().registerRequestFilter((type, request) => {
                    request.headers['Referer'] = 'https://www.jiotv.com/';
                    request.headers['User-Agent'] = "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6";
                    request.headers['Cookie'] = cookieHeader;

                    if ((type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
                         type === shaka.net.NetworkingEngine.RequestType.SEGMENT) &&
                        !request.uris[0].includes('__hdnea__=')) {
                        const separator = request.uris[0].includes('?') ? '&' : '?';
                        request.uris[0] += separator + cookieHeader;
                    }
                });
            }

            // Error handler
            player.addEventListener('error', (event) => {
                console.error('Shaka Player Error:', event.detail);
                
                // If Shaka fails, immediately switch to iframe
                console.log('Shaka failed, switching to iframe');
                switchToIframe();
            });

            // Play function - always start muted to ensure autoplay works
            const playVideo = async () => {
                try {
                    // Start with muted to ensure autoplay works
                    video.muted = true;
                    await video.play();
                    console.log('Video playing (muted)');
                    
                    // Show small mute indicator in corner
                    const muteIndicator = document.getElementById('muteIndicator');
                    muteIndicator.style.display = 'block';
                    
                    // Click anywhere to unmute
                    const unmuteOnClick = () => {
                        video.muted = false;
                        muteIndicator.style.display = 'none';
                        document.removeEventListener('click', unmuteOnClick);
                        document.removeEventListener('touchstart', unmuteOnClick);
                    };
                    
                    document.addEventListener('click', unmuteOnClick);
                    document.addEventListener('touchstart', unmuteOnClick);
                    
                    // Auto hide indicator after 5 seconds
                    setTimeout(() => {
                        muteIndicator.style.display = 'none';
                    }, 5000);
                    
                } catch (error) {
                    console.log('Video play failed:', error.message);
                    
                    // If Shaka play fails, switch to iframe
                    console.log('Play failed, switching to iframe');
                    switchToIframe();
                }
            };

            // Load the stream
            console.log('Loading stream:', streamUrl);
            await player.load(streamUrl);
            
            // Try to play
            await playVideo();
            
            console.log('Shaka player loaded successfully');
            
        } catch (error) {
            console.error('Shaka initialization failed:', error);
            
            // If Shaka fails, switch to iframe
            switchToIframe();
        }
    }

    // Main initialization
    document.addEventListener('DOMContentLoaded', async () => {
        // Get stream URL from URL parameter
        streamUrl = name;
        
        if (!streamUrl) {
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').querySelector('p').textContent = 'No stream URL provided. Please add ?url= parameter.';
            return;
        }

        // Try to fetch M3U for cookie
        try {
            const response = await fetch('https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u');
            const m3uText = await response.text();
            const lines = m3uText.split('\n');

            for (let i = 0; i < lines.length; i++) {
                const cookieLine = lines.find(line => line.startsWith('#EXTHTTP:'));
                if (cookieLine) {
                    const cookieMatch = cookieLine.match(/"cookie":"([^"]+)"/);
                    if (cookieMatch) {
                        cookieHeader = cookieMatch[1];
                        break;
                    }
                }
            }
        } catch (error) {
            console.log('Failed to fetch M3U, continuing without cookies:', error);
        }

        // Check if we should use iframe directly (for certain conditions)
        const useIframeDirectly = () => {
            // Always try Shaka first for now
            return false;
        };

        if (useIframeDirectly()) {
            // Use iframe directly
            switchToIframe();
        } else {
            // First, try Shaka player
            await initShakaPlayer();
        }
        
        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                const video = document.querySelector('video');
                if (video && video.paused && document.querySelector('.shaka-video-container').style.display !== 'none') {
                    video.play().catch(e => console.log('Resume play failed:', e));
                }
            }
        });
    });
</script>
</body>
</html>
